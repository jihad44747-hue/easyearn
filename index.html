<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Earn Now - User</title>

  <!-- Telegram Web App -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Ad scripts with error handling -->
  <script>
  // Ad blocker detection
  if (typeof window.adsBlocked === 'undefined') {
      window.adsBlocked = false;
  }
  </script>
  
  <script src="https://adexora.com/cdn/ads.js?id=141" 
          onerror="window.adsBlocked = true; console.log('Adexora failed to load')">
  </script>

  <!-- Firebase (compat - works with older code patterns) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <style>
    /* Your existing CSS styles remain the same */
    :root{
      --primary-gradient: linear-gradient(135deg,#6a11cb 0%,#2575fc 100%);
      --card-bg: rgba(255,255,255,0.95);
      --glass-bg: rgba(255,255,255,0.12);
      --text-dark: #222;
      --accent: #6a11cb;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
      --info: #17a2b8;
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:Inter,Segoe UI,Roboto,Arial;}
    body{background:var(--primary-gradient);min-height:100vh;padding:20px;color:var(--text-dark);display:flex;justify-content:center;}
    .app{width:100%;max-width:520px;background:var(--glass-bg);border-radius:16px;padding-bottom:30px;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,0.18);border:1px solid rgba(255,255,255,0.08);}
    header{background:linear-gradient(135deg,#2575fc 0%,#6a11cb 100%);color:#fff;padding:26px;text-align:center;}
    header h1{font-size:22px;margin-bottom:6px;}
    .balance-card{background:var(--card-bg);margin:18px auto;padding:18px;border-radius:12px;width:88%;text-align:center;box-shadow:0 6px 18px rgba(0,0,0,0.08);}
    .balance-amount{font-size:34px;color:var(--accent);font-weight:800;}
    .content{padding:18px;}
    .section{background:var(--card-bg);padding:18px;border-radius:12px;margin-bottom:14px;box-shadow:0 6px 18px rgba(0,0,0,0.06);}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:12px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700;transition:all 0.3s ease;}
    .btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.15);}
    .btn-primary{background:linear-gradient(90deg,#6a11cb,#2575fc);color:#fff;}
    .btn-secondary{background:#fff;border:1px solid #e6e6e6;color:#333;}
    .btn-success{background:linear-gradient(90deg,#28a745,#20c997);color:#fff;}
    .btn-warning{background:linear-gradient(90deg,#ffc107,#fd7e14);color:#fff;}
    .task-info{display:flex;justify-content:space-between;margin-top:10px;color:#666;font-size:13px;flex-wrap:wrap;}
    .task-info > div {margin-right:10px;}
    .task-progress{height:8px;background:#eee;border-radius:6px;margin-top:10px;overflow:hidden;}
    .task-bar{height:100%;background:linear-gradient(90deg,#6a11cb,#2575fc);width:0%}
    .withdrawal-form{margin-top:12px}
    .method-cards{display:flex;gap:8px;flex-wrap:wrap}
    .method-card{padding:10px;border-radius:10px;border:1px solid #e9e9e9;min-width:90px;text-align:center;cursor:pointer;background:#fff;transition:all 0.2s ease;}
    .method-card:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,0.1);}
    .method-card.selected{border-color:var(--accent);background:rgba(106,17,203,0.06)}
    .amount-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px}
    .amount-btn{padding:10px;border-radius:8px;border:1px solid #eee;background:#fff;cursor:pointer;font-weight:700;transition:all 0.2s ease;}
    .amount-btn:hover{transform:translateY(-2px);box-shadow:0 2px 4px rgba(0,0,0,0.1);}
    .amount-btn.selected{border-color:var(--accent);background:rgba(106,17,203,0.06)}
    .input{width:100%;padding:12px;border-radius:10px;border:1px solid #e9e9e9;margin-top:8px}
    .history-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:#fff;margin-bottom:8px;border:1px solid #f3f3f3}
    .status-badge{padding:6px 10px;border-radius:18px;font-weight:700;font-size:12px}
    .status-pending{background:#fff3cd;color:#856404}
    .status-paid{background:#d4edda;color:#155724}
    .status-rejected{background:#f8d7da;color:#721c24}
    .notification{position:fixed;top:20px;right:20px;padding:12px 16px;border-radius:10px;color:#fff;display:none;z-index:3000}
    .firebase-loading{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.5);z-index:4000}
    .ad-modal{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:3500}
    .ad-box{background:#fff;padding:20px;border-radius:12px;width:92%;max-width:360px;text-align:center}
    .small{font-size:13px;color:#666}
    
    /* New styles for community and referral sections */
    .community-section {display:flex;flex-direction:column;gap:12px;margin-top:12px;}
    .community-btn {width:100%;justify-content:center;text-align:center;}
    .referral-section {margin-top:16px;}
    .referral-code {background:#f8f9fa;padding:14px;border-radius:10px;margin-top:10px;text-align:center;border:1px dashed #ddd;}
    .referral-code-text {font-size:18px;font-weight:800;letter-spacing:1px;color:var(--accent);margin:8px 0;}
    .referral-stats {display:flex;justify-content:space-around;margin-top:14px;text-align:center;}
    .stat-box {flex:1;padding:10px;}
    .stat-value {font-size:20px;font-weight:800;color:var(--accent);}
    .stat-label {font-size:12px;color:#666;}
    .referral-instructions {margin-top:14px;padding:12px;background:#f0f8ff;border-radius:8px;border-left:4px solid var(--accent);}
    .referral-instructions ol {padding-left:20px;margin-top:8px;}
    .referral-instructions li {margin-bottom:6px;}
    
    /* New styles for referral bonuses */
    .referral-bonus-section {margin-top:16px;padding:12px;background:#f8f9fa;border-radius:8px;border:1px solid #e9ecef;}
    .bonus-claim-btn {width:100%;margin-top:10px;}
    
    /* Ad container styles */
    #adextraContainer {
      min-height: 200px;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f9f9f9;
      border-radius: 8px;
      margin: 10px 0;
    }
    
    .ad-fallback {
      padding: 20px;
      text-align: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 10px;
      width: 100%;
    }
    
    .ad-network-indicator {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 10px;
    }
    
    /* Animation for spin */
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    
    /* Countdown timer styles */
    .countdown-timer {
      font-size: 24px;
      font-weight: bold;
      color: #6a11cb;
      margin: 10px 0;
      text-align: center;
    }
    
    .countdown-container {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
      text-align: center;
    }
    
    /* Share modal styles */
    .share-modal {
      position: fixed;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.6);
      z-index: 3500;
    }
    
    .share-box {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      width: 92%;
      max-width: 360px;
      text-align: center;
    }
    
    .share-options {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    
    .share-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      padding: 10px;
      border-radius: 10px;
      transition: all 0.2s ease;
    }
    
    .share-option:hover {
      background: #f5f5f5;
      transform: translateY(-2px);
    }
    
    .share-icon {
      font-size: 30px;
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <div class="firebase-loading" id="firebaseLoading">
    <div style="text-align:center;color:white">
      <div style="width:48px;height:48px;border:4px solid rgba(255,255,255,0.2);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 10px"></div>
      <div>Loading...</div>
    </div>
  </div>

  <div class="notification" id="notification"></div>

  <div class="app" role="application">
    <header>
      <h1>Earn Now</h1>
      <div class="balance-card">
        <div class="small">Your Balance</div>
        <div class="balance-amount">‡ß≥ <span id="balance">0.00</span></div>
        <div class="small" id="current-date"></div>
      </div>
    </header>

    <div class="content">
      <div class="section">
        <h3>Watch Ads & Earn</h3>
        <div style="margin-top:12px">
          <button id="watchAdBtn" class="btn btn-primary">üëÅÔ∏è Watch Ad & Earn ‡ß≥<span id="perAd">0.06</span></button>
        </div>
        <div class="task-info">
          <div>Watched: <strong id="todayCount">0</strong>/<strong id="dailyLimit">10</strong></div>
          <div>Clicks: <strong id="todayClicks">0</strong></div>
          <div id="resetTime" class="small">Resets in 24h</div>
        </div>
        <div class="task-progress" aria-hidden="true"><div id="taskBar" class="task-bar"></div></div>
      </div>

      <!-- New Community Section -->
      <div class="section">
        <h3>Join Our Community</h3>
        <div class="community-section">
          <button id="joinChannelBtn" class="btn btn-success community-btn">üì¢ Join Our Channel</button>
          <button id="joinGroupBtn" class="btn btn-warning community-btn">üí¨ Join Support Group</button>
        </div>
      </div>

      <!-- New Referral Section -->
      <div class="section">
        <h3>Refer & Earn</h3>
        <div class="referral-section">
          <div class="small">Invite friends and earn ‡ß≥1 for each successful referral!</div>
          
          <div class="referral-code">
            <div class="small">Your Referral Code:</div>
            <div class="referral-code-text" id="referralCode">LOADING...</div>
            <button id="copyRefCode" class="btn btn-primary" style="margin-top:8px">üìã Copy Code</button>
            <button id="shareRefLink" class="btn btn-success" style="margin-top:8px">üîó Share Referral Link</button>
          </div>
          
          <div class="referral-stats">
            <div class="stat-box">
              <div class="stat-value" id="refCount">0</div>
              <div class="stat-label">Referrals</div>
            </div>
            <div class="stat-box">
              <div class="stat-value">‡ß≥<span id="refEarnings">0</span></div>
              <div class="stat-label">Earned</div>
            </div>
            <div class="stat-box">
              <div class="stat-value" id="pendingBonus">0</div>
              <div class="stat-label">Pending Bonus</div>
            </div>
          </div>
          
          <!-- Referral Bonus Claim Section -->
          <div class="referral-bonus-section">
            <div class="small" style="font-weight:700">Referral Bonuses:</div>
            <div class="small" style="margin-top:8px">
              <div>üéÅ New referral bonus: ‡ß≥1 (auto credit)</div>
              <div>üí∞ 10 TK balance bonus: ‡ß≥2 (claimable once per referral)</div>
            </div>
            <button id="claimRefBonus" class="btn btn-warning bonus-claim-btn">üí∞ Claim Referral Bonuses (‡ß≥<span id="claimableAmount">0</span>)</button>
          </div>
          
          <div class="referral-instructions">
            <div class="small" style="font-weight:700">How to refer:</div>
            <ol class="small">
              <li>Share your referral link with friends</li>
              <li>They need to open the link and use the mini app</li>
              <li>You get ‡ß≥1 when they join through your link</li>
              <li>When their balance reaches ‡ß≥10, you can claim ‡ß≥2 bonus</li>
            </ol>
          </div>
        </div>
      </div>

      <div class="section">
        <h3>Withdraw Money</h3>
        <div style="margin-top:10px">
          <button id="toggleWithdraw" class="btn btn-secondary">üí∏ Request Withdrawal</button>
        </div>

        <div id="withdrawForm" class="withdrawal-form" style="display:none">
          <div style="margin-top:10px">
            <div class="small">Select Method</div>
            <div id="methodCards" class="method-cards" style="margin-top:8px"></div>
          </div>

          <div style="margin-top:12px">
            <div class="small">Account / Mobile Number</div>
            <input id="accountNumber" class="input" placeholder="Enter number (e.g. 01XXXXXXXXX)">
          </div>

          <div style="margin-top:12px">
            <div class="small">Select Amount</div>
            <div class="amount-grid" id="amountGrid">
              <button class="amount-btn" data-amount="20">‡ß≥20</button>
              <button class="amount-btn" data-amount="50">‡ß≥50</button>
              <button class="amount-btn" data-amount="100">‡ß≥100</button>
              <button class="amount-btn" data-amount="200">‡ß≥200</button>
              <button class="amount-btn" data-amount="300">‡ß≥300</button>
              <button class="amount-btn" data-amount="500">‡ß≥500</button>
            </div>
            <input id="withdrawAmount" type="number" class="input" placeholder="Or enter custom amount (20 - 500)" min="20" max="500" style="margin-top:8px">
          </div>

          <div style="margin-top:14px">
            <button id="submitWithdraw" class="btn btn-primary">‚úÖ Submit Request</button>
          </div>
        </div>

        <h4 style="margin-top:18px">Withdrawal History</h4>
        <div id="historyList" style="margin-top:10px"></div>
      </div>
    </div>
  </div>

  <!-- Ad Modal -->
  <div class="ad-modal" id="adModal">
    <div class="ad-box">
      <h3>Advertisement</h3>
      <div style="margin:16px 0">
        <div style="width:48px;height:48px;border:4px solid #eee;border-top-color:#6a11cb;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto"></div>
      </div>
      <div id="adStatus" class="small">Playing ad...</div>
      <div style="margin-top:16px"><button id="adDoneBtn" class="btn btn-primary" style="display:none">OK</button></div>
    </div>
  </div>

  <!-- Share Modal -->
  <div class="share-modal" id="shareModal">
    <div class="share-box">
      <h3>Share Referral Link</h3>
      <div class="small" style="margin-top:8px">Share your referral link with friends and earn money!</div>
      
      <div class="share-options">
        <div class="share-option" id="shareTelegram">
          <div class="share-icon">üì±</div>
          <div class="small">Telegram</div>
        </div>
        <div class="share-option" id="shareFacebook">
          <div class="share-icon">üë•</div>
          <div class="small">Facebook</div>
        </div>
        <div class="share-option" id="shareWhatsApp">
          <div class="share-icon">üí¨</div>
          <div class="small">WhatsApp</div>
        </div>
        <div class="share-option" id="shareTwitter">
          <div class="share-icon">üê¶</div>
          <div class="small">Twitter</div>
        </div>
        <div class="share-option" id="shareCopy">
          <div class="share-icon">üìã</div>
          <div class="small">Copy Link</div>
        </div>
      </div>
      
      <div style="margin-top:16px">
        <button id="closeShareModal" class="btn btn-secondary">Close</button>
      </div>
    </div>
  </div>

<script>
/* ========== Helpers ========== */
function showNotification(msg, success=true, ms=2200){
  const el = document.getElementById('notification');
  el.textContent = msg;
  el.style.background = success ? 'linear-gradient(90deg,#28a745,#1e7e34)' : 'linear-gradient(90deg,#dc3545,#bd2130)';
  el.style.display = 'block';
  setTimeout(()=> el.style.display = 'none', ms);
}

/* ========== Firebase init ========== */
const firebaseConfig = {
  apiKey: "AIzaSyDp49URVg2ipSBuoEBGZyqWWyc29cxAleE",
  authDomain: "easy-earn-af82c.firebaseapp.com",
  projectId: "easy-earn-af82c",
  storageBucket: "easy-earn-af82c.firebasestorage.app",
  messagingSenderId: "572340074151",
  appId: "1:572340074151:web:778d58946c1163427acd82",
  measurementId: "G-3RFZSPZD9W"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const FieldValue = firebase.firestore.FieldValue;

/* ========== App state ========== */
let tg; // Telegram WebApp object
let uid = null;
let userData = { 
  balance: 0, 
  adHistory: [], 
  adClickHistory: [], 
  activityLog: [], 
  todayAdCount: 0, 
  todayAdClicks: 0, 
  lastAdReset: new Date().toDateString(),
  totalEarned: 0,
  totalWithdrawn: 0,
  referralCode: '',
  referredBy: '',
  referrals: [],
  referralEarnings: 0,
  isBlocked: false,
  // New referral bonus fields
  referralBonuses: {},
  claimedBonuses: []
};
let withdrawalMethods = [];
let allRequests = [];
let perAdRate = 0.06;
let dailyLimit = 10;
let userIP = "Unknown";
let userCountry = "Unknown";

/* ========== DOM refs ========== */
const balanceEl = () => document.getElementById('balance');
const perAdEl = () => document.getElementById('perAd');
const todayCountEl = () => document.getElementById('todayCount');
const todayClicksEl = () => document.getElementById('todayClicks');
const dailyLimitEl = () => document.getElementById('dailyLimit');
const taskBarEl = () => document.getElementById('taskBar');
const resetTimeEl = () => document.getElementById('resetTime');
const watchAdBtn = () => document.getElementById('watchAdBtn');
const toggleWithdrawBtn = () => document.getElementById('toggleWithdraw');
const withdrawFormEl = () => document.getElementById('withdrawForm');
const methodCardsEl = () => document.getElementById('methodCards');
const amountGridEl = () => document.getElementById('amountGrid');
const withdrawAmountInput = () => document.getElementById('withdrawAmount');
const accountNumberInput = () => document.getElementById('accountNumber');
const submitWithdrawBtn = () => document.getElementById('submitWithdraw');
const historyListEl = () => document.getElementById('historyList');
const firebaseLoading = () => document.getElementById('firebaseLoading');
const adModal = () => document.getElementById('adModal');
const adStatus = () => document.getElementById('adStatus');
const adDoneBtn = () => document.getElementById('adDoneBtn');

// New DOM refs for community and referral
const joinChannelBtn = () => document.getElementById('joinChannelBtn');
const joinGroupBtn = () => document.getElementById('joinGroupBtn');
const referralCodeEl = () => document.getElementById('referralCode');
const copyRefCodeBtn = () => document.getElementById('copyRefCode');
const shareRefLinkBtn = () => document.getElementById('shareRefLink');
const refCountEl = () => document.getElementById('refCount');
const refEarningsEl = () => document.getElementById('refEarnings');
const pendingBonusEl = () => document.getElementById('pendingBonus');
const claimRefBonusBtn = () => document.getElementById('claimRefBonus');
const claimableAmountEl = () => document.getElementById('claimableAmount');

// Share modal DOM refs
const shareModal = () => document.getElementById('shareModal');
const shareTelegram = () => document.getElementById('shareTelegram');
const shareFacebook = () => document.getElementById('shareFacebook');
const shareWhatsApp = () => document.getElementById('shareWhatsApp');
const shareTwitter = () => document.getElementById('shareTwitter');
const shareCopy = () => document.getElementById('shareCopy');
const closeShareModal = () => document.getElementById('closeShareModal');

/* ========== Utility functions ========== */
function formatDateField(d){
  if(!d) return '';
  if (d && typeof d.toDate === 'function') {
    return d.toDate().toLocaleString();
  } else if (typeof d === 'string') {
    try { return new Date(d).toLocaleString(); } catch(e){ return d; }
  } else if (d instanceof Date) return d.toLocaleString();
  return String(d);
}

function updateResetTimeUI(){
  const now = new Date();
  const tomorrow = new Date(now);
  tomorrow.setDate(tomorrow.getDate()+1);
  tomorrow.setHours(0,0,0,0);
  const diff = tomorrow - now;
  const hrs = Math.floor(diff/(1000*60*60));
  const mins = Math.floor((diff%(1000*60*60))/(1000*60));
  resetTimeEl().textContent = `Resets in ${hrs}h ${mins}m`;
}

// Ad click simulation
function simulateAdClick() {
  return new Promise((resolve) => {
    const clicked = Math.random() < 0.7;
    setTimeout(() => resolve(clicked), 1000);
  });
}

// Generate referral code
function generateReferralCode() {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let result = '';
  for (let i = 0; i < 6; i++) {
    result += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return result;
}

// Generate referral link
function generateReferralLink() {
  const botUsername = 'easyearn11_bot'; // Your actual bot username
  return `https://t.me/${botUsername}?start=${userData.referralCode}`;
}

// Generate share text
function generateShareText() {
  const link = generateReferralLink();
  return `Join EasyEarn and start earning money by watching ads! Use my referral code: ${userData.referralCode}\n\n${link}`;
}

/* ========== Daily Reset Logic ========== */
function checkAndResetDailyCounts() {
  const today = new Date().toDateString();
  if (userData.lastAdReset !== today) {
    console.log('Resetting daily counts for new day');
    
    // ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶°‡ßá‡¶á‡¶≤‡¶ø ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®, ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶®‡¶Ø‡¶º
    userData.lastAdReset = today;
    userData.todayAdCount = 0;
    userData.todayAdClicks = 0;
    
    // ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
    saveUserToServer().catch(e => console.error('Reset save error:', e));
    return true;
  }
  return false;
}

/* ========== Load user IP & country ========== */
async function detectLocation(){
  try {
    const r = await fetch('https://api.ipify.org?format=json');
    const j = await r.json();
    userIP = j.ip || 'Unknown';
    const r2 = await fetch(`https://ipapi.co/${userIP}/json/`);
    const j2 = await r2.json();
    userCountry = j2.country_code || 'Unknown';
  } catch(e){
    console.warn('Location detect failed', e);
    userIP = 'Unknown'; userCountry = 'Unknown';
  }
}

/* ========== Load & Save from Firestore ========== */
async function loadUserFromServer(){
  try {
    const doc = await db.collection('users').doc(uid).get();
    if (doc.exists){
      const data = doc.data();
      
      // ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶è‡¶¨‡¶Ç ‡¶™‡¶æ‡¶∞‡ßç‡¶Æ‡¶æ‡¶®‡ßá‡¶®‡ßç‡¶ü ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®
      userData.balance = parseFloat(data.balance || 0);
      userData.totalEarned = parseFloat(data.totalEarned || 0);
      userData.totalWithdrawn = parseFloat(data.totalWithdrawn || 0);
      userData.adHistory = data.adHistory || [];
      userData.adClickHistory = data.adClickHistory || [];
      userData.activityLog = data.activityLog || [];
      userData.registrationDate = data.registrationDate || new Date().toISOString();
      userData.userId = data.userId || uid;
      userData.isBlocked = data.isBlocked || false;
      
      // Referral data
      userData.referralCode = data.referralCode || generateReferralCode();
      userData.referredBy = data.referredBy || '';
      userData.referrals = data.referrals || [];
      userData.referralEarnings = parseFloat(data.referralEarnings || 0);
      
      // New referral bonus data
      userData.referralBonuses = data.referralBonuses || {};
      userData.claimedBonuses = data.claimedBonuses || [];
      
      // ‡¶°‡ßá‡¶á‡¶≤‡¶ø ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
      userData.todayAdCount = parseInt(data.todayAdCount || 0);
      userData.todayAdClicks = parseInt(data.todayAdClicks || 0);
      userData.lastAdReset = data.lastAdReset || new Date().toDateString();
      
      // ‡¶°‡ßá‡¶á‡¶≤‡¶ø ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
      checkAndResetDailyCounts();
      
      console.log('User data loaded - Balance:', userData.balance, 'Today Count:', userData.todayAdCount);
    } else {
      // ‡¶®‡¶§‡ßÅ‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®
      const today = new Date().toDateString();
      userData = {
        balance: 0,
        totalEarned: 0,
        totalWithdrawn: 0,
        adHistory: [],
        adClickHistory: [],
        activityLog: [],
        todayAdCount: 0,
        todayAdClicks: 0,
        lastAdReset: today,
        registrationDate: new Date().toISOString(),
        userId: uid,
        referralCode: generateReferralCode(),
        referredBy: '',
        referrals: [],
        referralEarnings: 0,
        isBlocked: false,
        referralBonuses: {},
        claimedBonuses: []
      };
      await db.collection('users').doc(uid).set(userData);
      console.log('New user created');
    }
  } catch (e){
    console.error('loadUserFromServer error', e);
    showNotification('Error loading user data', false);
    userData.balance = 0;
  }
}

// Check for referral code in URL parameters
function checkReferralCode() {
  try {
    if (tg && tg.initDataUnsafe && tg.initDataUnsafe.start_param) {
      const referralCode = tg.initDataUnsafe.start_param;
      if (referralCode && referralCode !== userData.referralCode) {
        // This user came through a referral link
        processReferral(referralCode);
      }
    }
  } catch (e) {
    console.error('Error checking referral code:', e);
  }
}

// Process referral when a new user joins
async function processReferral(referralCode) {
  try {
    // Find the referrer by referral code
    const referrerQuery = await db.collection('users').where('referralCode', '==', referralCode).get();
    
    if (!referrerQuery.empty) {
      const referrerDoc = referrerQuery.docs[0];
      const referrerData = referrerDoc.data();
      const referrerId = referrerDoc.id;
      
      // Add this user to referrer's referrals if not already added
      if (!userData.referredBy) {
        userData.referredBy = referrerId;
        
        // Update referrer's data
        const updatedReferrals = [...(referrerData.referrals || []), uid];
        const updatedBonuses = {...(referrerData.referralBonuses || {})};
        
        // Add bonus for this referral
        updatedBonuses[uid] = {
          joined: new Date().toISOString(),
          bonus1Given: false, // ‡ß≥1 bonus for new referral
          bonus2Eligible: false, // ‡ß≥2 bonus when user reaches 10 TK
          bonus2Claimed: false
        };
        
        await db.collection('users').doc(referrerId).update({
          referrals: updatedReferrals,
          referralBonuses: updatedBonuses
        });
        
        // Give immediate ‡ß≥1 bonus to referrer
        await db.collection('users').doc(referrerId).update({
          balance: parseFloat(referrerData.balance || 0) + 1,
          referralEarnings: parseFloat(referrerData.referralEarnings || 0) + 1
        });
        
        // Mark bonus as given
        updatedBonuses[uid].bonus1Given = true;
        await db.collection('users').doc(referrerId).update({
          referralBonuses: updatedBonuses
        });
        
        console.log('Referral processed successfully');
        
        // Update local user data if current user is the referrer
        if (uid === referrerId) {
          userData.referrals = updatedReferrals;
          userData.referralBonuses = updatedBonuses;
          userData.balance += 1;
          userData.referralEarnings += 1;
        }
      }
    }
  } catch (e) {
    console.error('Error processing referral:', e);
  }
}

// Check and update referral bonuses based on referred users' balances
async function updateReferralBonuses() {
  try {
    if (!userData.referrals || userData.referrals.length === 0) return;
    
    let updated = false;
    const updatedBonuses = {...userData.referralBonuses};
    
    for (const referredUserId of userData.referrals) {
      if (updatedBonuses[referredUserId] && 
          !updatedBonuses[referredUserId].bonus2Eligible && 
          !updatedBonuses[referredUserId].bonus2Claimed) {
        
        // Check referred user's balance
        const referredUserDoc = await db.collection('users').doc(referredUserId).get();
        if (referredUserDoc.exists) {
          const referredUserData = referredUserDoc.data();
          const referredBalance = parseFloat(referredUserData.balance || 0);
          
          if (referredBalance >= 10) {
            updatedBonuses[referredUserId].bonus2Eligible = true;
            updated = true;
          }
        }
      }
    }
    
    if (updated) {
      userData.referralBonuses = updatedBonuses;
      await db.collection('users').doc(uid).update({
        referralBonuses: updatedBonuses
      });
    }
  } catch (e) {
    console.error('Error updating referral bonuses:', e);
  }
}

// Calculate claimable bonus amount
function calculateClaimableBonus() {
  let totalClaimable = 0;
  
  if (userData.referralBonuses) {
    for (const referredUserId of userData.referrals) {
      const bonus = userData.referralBonuses[referredUserId];
      if (bonus && bonus.bonus2Eligible && !bonus.bonus2Claimed) {
        totalClaimable += 2; // ‡ß≥2 per eligible referral
      }
    }
  }
  
  return totalClaimable;
}

// Claim referral bonuses
async function claimReferralBonuses() {
  const claimableAmount = calculateClaimableBonus();
  
  if (claimableAmount <= 0) {
    showNotification('No bonuses available to claim', false);
    return;
  }
  
  try {
    const updatedBonuses = {...userData.referralBonuses};
    let claimedCount = 0;
    
    for (const referredUserId of userData.referrals) {
      const bonus = updatedBonuses[referredUserId];
      if (bonus && bonus.bonus2Eligible && !bonus.bonus2Claimed) {
        updatedBonuses[referredUserId].bonus2Claimed = true;
        claimedCount++;
      }
    }
    
    // Update user balance and bonuses
    userData.balance += claimableAmount;
    userData.referralEarnings += claimableAmount;
    userData.referralBonuses = updatedBonuses;
    userData.claimedBonuses.push({
      date: new Date().toISOString(),
      amount: claimableAmount,
      referrals: claimedCount
    });
    
    await db.collection('users').doc(uid).update({
      balance: userData.balance,
      referralEarnings: userData.referralEarnings,
      referralBonuses: updatedBonuses,
      claimedBonuses: userData.claimedBonuses
    });
    
    showNotification(`Successfully claimed ‡ß≥${claimableAmount} referral bonus!`);
    renderUI();
    
  } catch (e) {
    console.error('Error claiming referral bonuses:', e);
    showNotification('Error claiming bonuses', false);
  }
}

async function loadWithdrawalRequests(){
  try {
    const snap = await db.collection('withdrawalRequests')
      .where('userId', '==', uid)
      .orderBy('date', 'desc')
      .get();
    
    allRequests = snap.docs.map(d => ({ 
      id: d.id, 
      ...d.data(),
      date: d.data().date || new Date().toISOString()
    }));
  } catch(e){
    console.error('loadWithdrawalRequests error', e);
    // Fallback: try without ordering
    try {
      const snap = await db.collection('withdrawalRequests')
        .where('userId', '==', uid)
        .get();
      allRequests = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    } catch(err) {
      console.error('Fallback load error:', err);
      allRequests = [];
    }
  }
}

async function loadSettings(){
  try {
    const s = await db.collection('settings').doc('appSettings').get();
    if (s.exists){
      const v = s.data();
      perAdRate = parseFloat(v.perAdRate || perAdRate);
      dailyLimit = parseInt(v.dailyTaskLimit || dailyLimit);
    }
    const methodsDoc = await db.collection('settings').doc('withdrawalMethods').get();
    if (methodsDoc.exists){
      const vm = methodsDoc.data();
      withdrawalMethods = vm.methods || [];
    } else {
      withdrawalMethods = [
        { name: 'bKash', enabled: true },
        { name: 'Nagad', enabled: true },
        { name: 'Rocket', enabled: true },
        { name: 'Banglalink', enabled: true },
        { name: 'Grameenphone', enabled: true },
        { name: 'Robi', enabled: true },
        { name: 'Airtel', enabled: true }
      ];
    }
    
    // Check country restrictions
    const countrySettingsDoc = await db.collection('settings').doc('countryRestrictions').get();
    if (countrySettingsDoc.exists) {
      const countrySettings = countrySettingsDoc.data();
      const allowedCountries = countrySettings.allowedCountries || [];
      const restrictionEnabled = countrySettings.restrictionEnabled || false;
      
      if (restrictionEnabled && allowedCountries.length > 0) {
        if (!allowedCountries.includes(userCountry)) {
          // Block the user from watching ads
          watchAdBtn().disabled = true;
          showNotification('Service not available in your country.', false);
        }
      }
    }
  } catch(e){
    console.warn('loadSettings error', e);
  }
}

async function saveUserToServer(){
  try {
    await db.collection('users').doc(uid).set({
      ...userData,
      lastUpdate: new Date().toISOString()
    }, { merge: true });
    console.log('User data saved - Balance:', userData.balance, 'Today Count:', userData.todayAdCount);
  } catch(e){
    console.error('saveUserToServer error', e);
    showNotification('Error saving data', false);
  }
}

/* ========== UI render functions ========== */
function renderUI(){
  // Check if user is blocked
  if (userData.isBlocked) {
    watchAdBtn().disabled = true;
    toggleWithdrawBtn().disabled = true;
    showNotification('Your account has been blocked. Contact support.', false);
    return;
  }
  
  // ‡¶°‡ßá‡¶á‡¶≤‡¶ø ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
  checkAndResetDailyCounts();
  
  const balance = parseFloat(userData.balance || 0);
  balanceEl().textContent = balance.toFixed(2);
  
  perAdEl().textContent = perAdRate.toFixed(2);
  todayCountEl().textContent = userData.todayAdCount || 0;
  todayClicksEl().textContent = userData.todayAdClicks || 0;
  dailyLimitEl().textContent = dailyLimit;
  
  const pct = ((userData.todayAdCount || 0) / dailyLimit) * 100;
  taskBarEl().style.width = `${Math.min(pct,100)}%`;
  updateResetTimeUI();
  renderMethods();
  renderHistory();
  renderReferralUI();
}

function renderMethods(){
  const container = methodCardsEl();
  container.innerHTML = '';
  const enabled = (withdrawalMethods || []).filter(m=>m.enabled);
  if (enabled.length === 0){
    container.innerHTML = '<div class="small">No methods available</div>';
    return;
  }
  enabled.forEach(m=>{
    const div = document.createElement('div');
    div.className = 'method-card';
    div.dataset.method = m.name.toLowerCase();
    
    const logos = {
      'bkash': '??',
      'nagad': 'üì±', 
      'rocket': 'üöÄ',
      'banglalink': 'üì∂',
      'grameenphone': 'üìû',
      'robi': 'üî¥',
      'airtel': 'üÖ∞Ô∏è'
    };
    
    const logo = logos[m.name.toLowerCase()] || 'üí≥';
    
    div.innerHTML = `
      <div style="font-size:24px;margin-bottom:5px">${logo}</div>
      <div style="font-weight:800">${m.name}</div>
      <div class="small">Tap to select</div>
    `;
    div.addEventListener('click', ()=> {
      document.querySelectorAll('.method-card').forEach(c=>c.classList.remove('selected'));
      div.classList.add('selected');
    });
    container.appendChild(div);
  });
}

function renderHistory(){
  const container = historyListEl();
  container.innerHTML = '';
  const myReqs = (allRequests || []).filter(r => String(r.userId) === String(uid) || String(r.userId) === String(userData.userId));
  if (myReqs.length === 0){
    container.innerHTML = '<div class="small" style="padding:12px;text-align:center;color:#666">No withdrawal history</div>';
    return;
  }
  myReqs.forEach(r=>{
    const div = document.createElement('div');
    div.className = 'history-item';
    const left = document.createElement('div');
    
    let formattedDate = 'Unknown';
    if (r.date) {
      const dateObj = typeof r.date.toDate === 'function' ? r.date.toDate() : new Date(r.date);
      if (!isNaN(dateObj.getTime())) {
        const day = dateObj.getDate();
        const month = dateObj.getMonth() + 1;
        const year = dateObj.getFullYear();
        formattedDate = `${day}-${month}-${year}`;
      }
    }
    
    left.innerHTML = `<div style="font-weight:800">${(r.method||'--').toString()}</div><div class="small">${formattedDate}</div>`;
    const right = document.createElement('div');
    const statusClass = r.status === 'paid' ? 'status-paid' : (r.status === 'rejected' ? 'status-rejected' : 'status-pending');
    right.innerHTML = `<div style="text-align:right">‡ß≥${(r.amount||0)}<div style="margin-top:6px"><span class="status-badge ${statusClass}">${r.status || 'pending'}</span></div></div>`;
    div.appendChild(left); div.appendChild(right);
    container.appendChild(div);
  });
}

function renderReferralUI() {
  referralCodeEl().textContent = userData.referralCode || 'N/A';
  refCountEl().textContent = userData.referrals ? userData.referrals.length : 0;
  refEarningsEl().textContent = userData.referralEarnings ? userData.referralEarnings.toFixed(2) : '0.00';
  
  // Calculate and display pending bonuses
  const claimableAmount = calculateClaimableBonus();
  pendingBonusEl().textContent = claimableAmount;
  claimableAmountEl().textContent = claimableAmount;
  
  // Enable/disable claim button
  if (claimableAmount > 0) {
    claimRefBonusBtn().disabled = false;
    claimRefBonusBtn().style.opacity = '1';
  } else {
    claimRefBonusBtn().disabled = true;
    claimRefBonusBtn().style.opacity = '0.7';
  }
}

/* ========== Community and Referral Functions ========== */
function openCommunityChannel() {
  window.open('https://t.me/easyearn1211', '_blank');
}

function openSupportGroup() {
  window.open('https://t.me/+kx6C43GeG4ljY2Jl', '_blank');
}

function copyReferralCode() {
  const code = userData.referralCode;
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(code).then(() => {
      showNotification('Referral code copied to clipboard!');
    }).catch(err => {
      fallbackCopyText(code);
    });
  } else {
    fallbackCopyText(code);
  }
}

function shareReferralLink() {
  shareModal().style.display = 'flex';
}

function fallbackCopyText(text) {
  const textArea = document.createElement("textarea");
  textArea.value = text;
  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();
  try {
    document.execCommand('copy');
    showNotification('Copied to clipboard!');
  } catch (err) {
    console.error('Fallback: Unable to copy', err);
    showNotification('Failed to copy. Please copy manually.', false);
  }
  document.body.removeChild(textArea);
}

/* ========== Share Functions ========== */
function shareToTelegram() {
  const text = generateShareText();
  const url = `https://t.me/share/url?url=${encodeURIComponent(generateReferralLink())}&text=${encodeURIComponent(text)}`;
  window.open(url, '_blank');
  shareModal().style.display = 'none';
  showNotification('Telegram share opened!');
}

function shareToFacebook() {
  const url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(generateReferralLink())}&quote=${encodeURIComponent('Join EasyEarn and start earning money by watching ads!')}`;
  window.open(url, '_blank');
  shareModal().style.display = 'none';
  showNotification('Facebook share opened!');
}

function shareToWhatsApp() {
  const text = generateShareText();
  const url = `https://api.whatsapp.com/send?text=${encodeURIComponent(text)}`;
  window.open(url, '_blank');
  shareModal().style.display = 'none';
  showNotification('WhatsApp share opened!');
}

function shareToTwitter() {
  const text = 'Join EasyEarn and start earning money by watching ads!';
  const url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(generateReferralLink())}`;
  window.open(url, '_blank');
  shareModal().style.display = 'none';
  showNotification('Twitter share opened!');
}

function copyReferralLink() {
  const link = generateReferralLink();
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(link).then(() => {
      showNotification('Referral link copied to clipboard!');
    }).catch(err => {
      fallbackCopyText(link);
    });
  } else {
    fallbackCopyText(link);
  }
  shareModal().style.display = 'none';
}

/* ========== Withdraw flow ========== */
async function submitWithdrawRequest(){
  const selected = document.querySelector('.method-card.selected');
  if (!selected) return showNotification('Please select a withdrawal method', false);
  const method = selected.dataset.method;
  const number = accountNumberInput().value.trim();
  let amount = parseFloat(withdrawAmountInput().value);
  
  // Validation improvements
  if (!number) return showNotification('Please enter account number', false);
  if (number.length < 11) return showNotification('Please enter valid account number (11 digits)', false);
  if (isNaN(amount) || amount <= 0) return showNotification('Please enter valid amount', false);
  if (amount < 20 || amount > 500) return showNotification('Amount must be between 20 and 500', false);
  if (userData.balance < amount) return showNotification('Insufficient balance', false);

  const userRef = db.collection('users').doc(uid);
  const reqsRef = db.collection('withdrawalRequests');

  try {
    // Show loading
    submitWithdrawBtn().disabled = true;
    submitWithdrawBtn().textContent = 'Submitting...';

    // Use transaction for data consistency
    await db.runTransaction(async (tx) => {
      const userSnap = await tx.get(userRef);
      if (!userSnap.exists) throw new Error('User not found');
      
      const serverUser = userSnap.data();
      const serverBalance = parseFloat(serverUser.balance || 0);
      
      if (serverBalance < amount) throw new Error('INSUFFICIENT_BALANCE');

      // Update user balance
      tx.update(userRef, {
        balance: serverBalance - amount,
        totalWithdrawn: parseFloat(serverUser.totalWithdrawn || 0) + amount,
        lastUpdate: new Date().toISOString()
      });

      // Create withdrawal request
      const newReqRef = reqsRef.doc();
      tx.set(newReqRef, {
        userId: uid,
        method: method,
        number: number,
        amount: amount,
        status: 'pending',
        date: new Date().toISOString(), // Use client timestamp
        ip: userIP,
        country: userCountry,
        userName: userData.name || 'Unknown',
        userUsername: userData.username || 'Unknown'
      });
    });

    // Update local data
    userData.balance = parseFloat(userData.balance || 0) - amount;
    userData.totalWithdrawn = parseFloat(userData.totalWithdrawn || 0) + amount;
    
    // Add to activity log
    userData.activityLog = userData.activityLog || [];
    userData.activityLog.push({
      type: 'withdrawal',
      date: new Date().toISOString(),
      amount: amount,
      method: method,
      number: number,
      status: 'pending',
      ip: userIP,
      country: userCountry
    });

    // Reload and update UI
    await loadWithdrawalRequests();
    renderUI();

    // Reset form
    document.querySelectorAll('.method-card').forEach(c=>c.classList.remove('selected'));
    document.querySelectorAll('.amount-btn').forEach(b=>b.classList.remove('selected'));
    accountNumberInput().value = '';
    withdrawAmountInput().value = '';
    withdrawFormEl().style.display = 'none';

    showNotification('Withdrawal request submitted successfully!');
    
    // Save user data (without balance update as it's already done in transaction)
    await saveUserToServer();

  } catch (err){
    console.error('Withdraw transaction error', err);
    
    if (err && err.message === 'INSUFFICIENT_BALANCE') {
      showNotification('Insufficient balance', false);
    } else if (err && err.message.includes('permission')) {
      showNotification('Database permission error. Please contact support.', false);
    } else if (err && err.message.includes('offline')) {
      showNotification('Network error. Please check your connection.', false);
    } else {
      showNotification('Could not submit withdrawal. Please try again.', false);
    }
  } finally {
    // Reset button state
    submitWithdrawBtn().disabled = false;
    submitWithdrawBtn().textContent = '‚úÖ Submit Request';
  }
}

/* ========== Watch ad flow ========== */
async function onAdEarn(){
  // ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶°‡ßá‡¶á‡¶≤‡¶ø ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
  checkAndResetDailyCounts();
  
  const currentBalance = parseFloat(userData.balance || 0);
  
  if ((userData.todayAdCount || 0) >= dailyLimit){
    return showNotification('You reached daily ad limit', false);
  }

  adModal().style.display = 'flex';
  adStatus().textContent = 'Playing ad...';
  adDoneBtn().style.display = 'none';

  const playAd = () => new Promise((resolve, reject) => {
    // Check if ad scripts are blocked
    if (window.adsBlocked) {
      setTimeout(resolve, 1800);
      return;
    }
    
    // Use only Adexora
    if (typeof window.showAdexora === 'function'){
      window.showAdexora().then(resolve).catch(reject);
    } else {
      setTimeout(resolve, 1800);
    }
  });

  try {
    await playAd();
    const adClicked = await simulateAdClick();
    
    adStatus().textContent = adClicked ? 'Ad clicked! +1 click' : 'Ad finished';
    adDoneBtn().style.display = 'inline-flex';

    userData.todayAdCount = (userData.todayAdCount || 0) + 1;
    userData.balance = currentBalance + parseFloat(perAdRate);
    userData.totalEarned = parseFloat(userData.totalEarned || 0) + parseFloat(perAdRate);

    userData.adHistory = userData.adHistory || [];
    userData.activityLog = userData.activityLog || [];
    
    const rec = { date: new Date().toISOString(), amount: perAdRate };
    userData.adHistory.push(rec);
    userData.activityLog.push({
      type: 'ad', 
      date: new Date().toISOString(), 
      amount: perAdRate, 
      ip: userIP, 
      country: userCountry 
    });

    if (adClicked) {
      userData.todayAdClicks = (userData.todayAdClicks || 0) + 1;
      userData.adClickHistory = userData.adClickHistory || [];
      userData.adClickHistory.push({ date: new Date().toISOString() });
      userData.activityLog.push({
        type: 'ad_click', 
        date: new Date().toISOString(), 
        ip: userIP, 
        country: userCountry 
      });
    }

    await saveUserToServer();
    await loadWithdrawalRequests();
    renderUI();
    showNotification('You earned ‡ß≥' + parseFloat(perAdRate).toFixed(2) + (adClicked ? ' +1 click' : ''));
  } catch (e){
    console.error('Ad play error', e);
    showNotification('Ad failed to play', false);
    adModal().style.display = 'none';
  }
}

adDoneBtn().addEventListener('click', ()=> { adModal().style.display = 'none'; });

/* ========== Boot sequence ========== */
document.addEventListener('DOMContentLoaded', async () => {
  try {
    tg = window.Telegram.WebApp;
    if (tg) tg.expand();
  } catch(e){}

  firebaseLoading().style.display = 'flex';

  try {
    if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id){
      uid = 'user_' + tg.initDataUnsafe.user.id;
      userData.userId = uid;
      userData.name = tg.initDataUnsafe.user.first_name || '';
      userData.username = tg.initDataUnsafe.user.username || '';
    } else {
      uid = 'guest_' + (localStorage.getItem('guestId') || (Math.floor(Math.random()*90000)+10000));
      localStorage.setItem('guestId', uid);
      userData.userId = uid;
    }
  } catch(e){
    uid = 'guest_' + Math.floor(Math.random()*999999);
    userData.userId = uid;
  }

  await detectLocation();

  try {
    await loadUserFromServer();
    await loadSettings();
    await loadWithdrawalRequests();
    
    // Check for referral code and process if available
    checkReferralCode();
    
    // Update referral bonuses based on referred users' balances
    await updateReferralBonuses();
    
    renderUI();
    
    firebaseLoading().style.display = 'none';
    
    document.getElementById('current-date').textContent = new Date().toDateString();
    
    // Event listeners
    watchAdBtn().addEventListener('click', onAdEarn);
    toggleWithdrawBtn().addEventListener('click', ()=> {
      withdrawFormEl().style.display = (withdrawFormEl().style.display === 'none' || withdrawFormEl().style.display === '') ? 'block' : 'none';
    });

    document.querySelectorAll('.amount-btn').forEach(b => {
      b.addEventListener('click', (ev)=>{
        document.querySelectorAll('.amount-btn').forEach(x=>x.classList.remove('selected'));
        b.classList.add('selected');
        withdrawAmountInput().value = b.dataset.amount;
      });
    });

    submitWithdrawBtn().addEventListener('click', submitWithdrawRequest);
    
    // New event listeners for community and referral
    joinChannelBtn().addEventListener('click', openCommunityChannel);
    joinGroupBtn().addEventListener('click', openSupportGroup);
    copyRefCodeBtn().addEventListener('click', copyReferralCode);
    shareRefLinkBtn().addEventListener('click', shareReferralLink);
    claimRefBonusBtn().addEventListener('click', claimReferralBonuses);
    
    // Share modal event listeners
    shareTelegram().addEventListener('click', shareToTelegram);
    shareFacebook().addEventListener('click', shareToFacebook);
    shareWhatsApp().addEventListener('click', shareToWhatsApp);
    shareTwitter().addEventListener('click', shareToTwitter);
    shareCopy().addEventListener('click', copyReferralLink);
    closeShareModal().addEventListener('click', () => { shareModal().style.display = 'none'; });

    setInterval(updateResetTimeUI, 60*1000);
    
  } catch (error) {
    console.error('Boot sequence error:', error);
    firebaseLoading().style.display = 'none';
    showNotification('Loading failed. Please refresh.', false);
  }
});
</script>
</body>
</html>
